(window.webpackJsonp=window.webpackJsonp||[]).push([[138],{663:function(e,a,t){"use strict";t.r(a);var d=t(1),s=Object(d.a)({},(function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"middlewares"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#middlewares"}},[e._v("#")]),e._v(" Middlewares")]),e._v(" "),t("p",{attrs:{synopsis:""}},[t("code",[e._v("Middlewares")]),e._v(" are objects that the developer can create to add logic before or after the transaction handler in a composable manner.")]),e._v(" "),t("h2",{attrs:{id:"pre-requisite-readings"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#pre-requisite-readings"}},[e._v("#")]),e._v(" Pre-requisite Readings")]),e._v(" "),t("ul",[t("li",{attrs:{prereq:""}},[t("RouterLink",{attrs:{to:"/basics/app-anatomy.html"}},[e._v("Anatomy of a Cosmos SDK Application")])],1),e._v(" "),t("li",{attrs:{prereq:""}},[t("RouterLink",{attrs:{to:"/core/transactions.html"}},[e._v("Transactons")])],1)]),e._v(" "),t("h2",{attrs:{id:"middlewares-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#middlewares-2"}},[e._v("#")]),e._v(" Middlewares")]),e._v(" "),t("p",[e._v("The SDK Baseapp's implementation of ABCI CheckTx, DeliverTx, and Baseapp's own Simulate methods use a middleware-based design. Middlewares can add logic to be executed before or after a transaction handler execution. Middlewares are like an "),t("code",[e._v("antehandler")]),e._v(" with the added feature of being able to add post-transaction handler execution. Middlewares allow us to solve use cases like transaction Tips and refund unused gas (issue "),t("a",{attrs:{href:"https://github.com/cosmos/cosmos-sdk/issues/2150",target:"_blank",rel:"noopener noreferrer"}},[e._v("#2150"),t("OutboundLink")],1),e._v(").")]),e._v(" "),t("h3",{attrs:{id:"type-definition"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#type-definition"}},[e._v("#")]),e._v(" Type Definition")]),e._v(" "),t("p",[e._v("The two following interfaces are the base of the middleware design, and are defined in types/tx:")]),e._v(" "),t("p",[t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gVHhIYW5kbGVyIGRlZmluZXMgdGhlIGJhc2VhcHAncyBDaGVja1R4LCBEZWxpdmVyVHggYW5kIFNpbXVsYXRlIHJlc3BlY3RpdmUKLy8gaGFuZGxlcnMuIEl0IGlzIGRlc2lnbmVkIGFzIGEgbWlkZGxld2FyZSBzdGFjay4KdHlwZSBIYW5kbGVyIGludGVyZmFjZSB7CglDaGVja1R4KGN0eCBjb250ZXh0LkNvbnRleHQsIHJlcSBSZXF1ZXN0LCBjaGVja1JlcSBSZXF1ZXN0Q2hlY2tUeCkgKFJlc3BvbnNlLCBSZXNwb25zZUNoZWNrVHgsIGVycm9yKQoJRGVsaXZlclR4KGN0eCBjb250ZXh0LkNvbnRleHQsIHJlcSBSZXF1ZXN0KSAoUmVzcG9uc2UsIGVycm9yKQoJU2ltdWxhdGVUeChjdHggY29udGV4dC5Db250ZXh0LCByZXEgUmVxdWVzdCkgKFJlc3BvbnNlLCBlcnJvcikKfQoKLy8gVHhNaWRkbGV3YXJlIGRlZmluZXMgb25lIGxheWVyIG9mIHRoZSBUeEhhbmRsZXIgbWlkZGxld2FyZSBzdGFjay4KdHlwZSBNaWRkbGV3YXJlIGZ1bmMoSGFuZGxlcikgSGFuZGxlcg=="}})],1),e._v(" "),t("p",[e._v("Where we define the following arguments and return types:")]),e._v(" "),t("p",[t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gUmVxdWVzdCBpcyB0aGUgdHggcmVxdWVzdCB0eXBlIHVzZWQgaW4gbWlkZGxld2FyZXMuCi8vIEF0IGxlYXN0IG9uZSBvZiBUeCBvciBUeEJ5dGVzIG11c3QgYmUgc2V0LiBJZiBvbmx5IFR4Qnl0ZXMgaXMgc2V0LCB0aGVuCi8vIFR4IHdpbGwgYmUgcG9wdWxhdGVkIGJ5IHRoZSBUeERlY29kZXJNaWRkbGV3YXJlLiBJZiBvbmx5IFR4IGlzIHNldCwgdGhlbgovLyBzb21lIG1pZGRsZXdhcmVzIChzdWNoIGFzIHNpZ25hdHVyZSB2ZXJpZmljYXRpb24pIHdpbGwgZmFpbC4KLy8KLy8gSW4gcHJhY3RpY2UsIHRoZSBtaWRkbGV3YXJlIHN0YWNrIGlzIGNhbGxlZCBmcm9tIHtDaGVjayxEZWxpdmVyfVR4LCB3aGljaAovLyBvbmx5IHBhc3NlcyB0aGUgVHhCeXRlcy4gVGhlbiwgdGhlIFR4RGVjb2Rlck1pZGRsZXdhcmUgZGVjb2RlcyB0aGUgYnl0ZXMKLy8gaW50byB0aGUgVHggZmllbGQuCnR5cGUgUmVxdWVzdCBzdHJ1Y3QgewoJVHggICAgICBzZGsuVHgKCVR4Qnl0ZXMgW11ieXRlCn0KCi8vIFJlc3BvbnNlIGlzIHRoZSB0eCByZXNwb25zZSB0eXBlIHVzZWQgaW4gbWlkZGxld2FyZXMuCnR5cGUgUmVzcG9uc2Ugc3RydWN0IHsKCUdhc1dhbnRlZCB1aW50NjQKCUdhc1VzZWQgICB1aW50NjQKCS8vIE1zZ1Jlc3BvbnNlcyBpcyBhbiBhcnJheSBjb250YWluaW5nIGVhY2ggTXNnIHNlcnZpY2UgaGFuZGxlcidzIHJlc3BvbnNlCgkvLyB0eXBlLCBwYWNrZWQgaW4gYW4gQW55LiBUaGlzIHdpbGwgZ2V0IHByb3RvLXNlcmlhbGl6ZWQgaW50byB0aGUgYERhdGFgIGZpZWxkCgkvLyBpbiB0aGUgQUJDSSBDaGVjay9EZWxpdmVyVHggcmVzcG9uc2VzLgoJTXNnUmVzcG9uc2VzIFtdKmNvZGVjdHlwZXMuQW55CglMb2cgICAgICAgICAgc3RyaW5nCglFdmVudHMgICAgICAgW11hYmNpLkV2ZW50Cn0KCi8vIFJlcXVlc3RDaGVja1R4IGlzIHRoZSBhZGRpdGlvbmFsIHJlcXVlc3QgdHlwZSB1c2VkIGluIG1pZGRsZXdhcmVzIENoZWNrVHgKLy8gbWV0aG9kLgp0eXBlIFJlcXVlc3RDaGVja1R4IHN0cnVjdCB7CglUeXBlIGFiY2kuQ2hlY2tUeFR5cGUKfQoKLy8gUmVxdWVzdENoZWNrVHggaXMgdGhlIGFkZGl0aW9uYWwgcmVzcG9uc2UgdHlwZSB1c2VkIGluIG1pZGRsZXdhcmVzIENoZWNrVHgKLy8gbWV0aG9kLgp0eXBlIFJlc3BvbnNlQ2hlY2tUeCBzdHJ1Y3QgewoJUHJpb3JpdHkgaW50NjQKfQ=="}})],1),e._v(" "),t("p",[e._v("BaseApp holds a reference to a "),t("code",[e._v("tx.Handler")]),e._v(", which will process the incoming transactions. It could be a simple "),t("code",[e._v("sdk.Msg")]),e._v(" executor, but in practice, it will be defined as a middleware stack wrapping around the base "),t("code",[e._v("sdk.Msg")]),e._v(" executor.")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"dHlwZSBCYXNlQXBwICBzdHJ1Y3QgewogICAgLy8gb3RoZXIgZmllbGRzCiAgICB0eEhhbmRsZXIgdHguSGFuZGxlcgp9Cg=="}}),e._v(" "),t("h2",{attrs:{id:"implementing-a-middleware"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#implementing-a-middleware"}},[e._v("#")]),e._v(" Implementing a Middleware")]),e._v(" "),t("p",[e._v("To implement a middleware is done simply by a Go function that takes as arguments and some parameters and returns a "),t("code",[e._v("tx.Middleware")]),e._v(".")]),e._v(" "),t("p",[e._v("For example, we can create a Generic middleware.")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gbXlUeEhhbmRsZXIgaXMgdGhlIHR4LkhhbmRsZXIgb2YgdGhpcyBtaWRkbGV3YXJlLiBOb3RlIHRoYXQgaXQgaG9sZHMgYQovLyByZWZlcmVuY2UgdG8gdGhlIG5leHQgdHguSGFuZGxlciBpbiB0aGUgc3RhY2suCnR5cGUgbXlUeEhhbmRsZXIgc3RydWN0IHsKICAgIC8vIG5leHQgaXMgdGhlIG5leHQgdHguSGFuZGxlciBpbiB0aGUgbWlkZGxld2FyZSBzdGFjay4KICAgIG5leHQgdHguSGFuZGxlcgogICAgLy8gc29tZSBvdGhlciBmaWVsZHMgdGhhdCBhcmUgcmVsZXZhbnQgdG8gdGhlIG1pZGRsZXdhcmUgY2FuIGJlIGFkZGVkIGhlcmUKfQoKLy8gTmV3TXlNaWRkbGV3YXJlIHJldHVybnMgYSBtaWRkbGV3YXJlIHRoYXQgZG9lcyB0aGlzIGFuZCB0aGF0LgpmdW5jIE5ld015TWlkZGxld2FyZShhcmcxLCBhcmcyKSB0eC5NaWRkbGV3YXJlIHsKICAgIHJldHVybiBmdW5jICh0eGggdHguSGFuZGxlcikgdHguSGFuZGxlciB7CiAgICAgICAgcmV0dXJuIG15VHhIYW5kbGVyewogICAgICAgICAgICBuZXh0OiB0eGgsCiAgICAgICAgICAgIC8vIG9wdGlvbmFsbHksIHNldCBhcmcxLCBhcmcyLi4uIGlmIHRoZXkgYXJlIG5lZWRlZCBpbiB0aGUgbWlkZGxld2FyZQogICAgICAgIH0KICAgIH0KfQoKLy8gQXNzZXJ0IG15VHhIYW5kbGVyIGlzIGEgdHguSGFuZGxlci4KdmFyIF8gdHguSGFuZGxlciA9IG15VHhIYW5kbGVye30K"}}),e._v(" "),t("p",[e._v("Next we need to implement the middleware "),t("a",{attrs:{href:"#Type-Definition"}},[e._v("interface")]),e._v(".")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoaCBteVR4SGFuZGxlcikgQ2hlY2tUeChjdHggY29udGV4dC5Db250ZXh0LCByZXEgUmVxdWVzdCwgY2hlY2tSZXEgUmVxdWVzdGNoZWNrVHgpIChSZXNwb25zZSwgUmVzcG9uc2VDaGVja1R4LCBlcnJvcikgewogICAgLy8gQ2hlY2tUeCBzcGVjaWZpYyBwcmUtcHJvY2Vzc2luZyBsb2dpYwoKICAgIC8vIHJ1biB0aGUgbmV4dCBtaWRkbGV3YXJlCiAgICByZXMsIGNoZWNrUmVzLCBlcnIgOj0gdHhoLm5leHQuQ2hlY2tUeChjdHgsIHJlcSwgY2hlY2tSZXEpCgogICAgLy8gQ2hlY2tUeCBzcGVjaWZpYyBwb3N0LXByb2Nlc3NpbmcgbG9naWMKCiAgICByZXR1cm4gcmVzLCBjaGVja1JlcywgZXJyCn0KCmZ1bmMgKGggbXlUeEhhbmRsZXIpIERlbGl2ZXJUeChjdHggY29udGV4dC5Db250ZXh0LCByZXEgUmVxdWVzdCkgKFJlc3BvbnNlLCBlcnJvcikgewogICAgLy8gRGVsaXZlclR4IHNwZWNpZmljIHByZS1wcm9jZXNzaW5nIGxvZ2ljCgogICAgLy8gcnVuIHRoZSBuZXh0IG1pZGRsZXdhcmUKICAgIHJlcywgZXJyIDo9IHR4aC5uZXh0LkRlbGl2ZXJUeChjdHgsIHR4LCByZXEpCgogICAgLy8gRGVsaXZlclR4IHNwZWNpZmljIHBvc3QtcHJvY2Vzc2luZyBsb2dpYwoKICAgIHJldHVybiByZXMsIGVycgp9CgpmdW5jIChoIG15VHhIYW5kbGVyKSBTaW11bGF0ZVR4KGN0eCBjb250ZXh0LkNvbnRleHQsIHJlcSBSZXF1ZXN0KSAoUmVzcG9uc2UsIGVycm9yKSB7CiAgICAvLyBTaW11bGF0ZVR4IHNwZWNpZmljIHByZS1wcm9jZXNzaW5nIGxvZ2ljCgogICAgLy8gcnVuIHRoZSBuZXh0IG1pZGRsZXdhcmUKICAgIHJlcywgZXJyIDo9IHR4aC5uZXh0LlNpbXVsYXRlVHgoY3R4LCB0eCwgcmVxKQoKICAgIC8vIFNpbXVsYXRlVHggc3BlY2lmaWMgcG9zdC1wcm9jZXNzaW5nIGxvZ2ljCgogICAgcmV0dXJuIHJlcywgZXJyCn0K"}}),e._v(" "),t("h3",{attrs:{id:"composing-middlewares"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#composing-middlewares"}},[e._v("#")]),e._v(" Composing Middlewares")]),e._v(" "),t("p",[e._v("While BaseApp holds a reference to a "),t("code",[e._v("tx.Handler")]),e._v(", this "),t("code",[e._v("tx.Handler")]),e._v(" itself is defined using a middleware stack. The Cosmos SDK exposes a base (i.e. innermost) "),t("code",[e._v("tx.Handler")]),e._v(" called "),t("code",[e._v("RunMsgsTxHandler")]),e._v(", which executes messages. It holds a reference to the "),t("code",[e._v("MsgServiceRouter")]),e._v(", which is used to map each "),t("code",[e._v("sdk.Msg")]),e._v(" to the correct module's "),t("code",[e._v("Msg")]),e._v(" server handler.")]),e._v(" "),t("p",[e._v("Then, the app developer can compose multiple middlewares on top of the base "),t("code",[e._v("tx.Handler")]),e._v(". Each middleware can run pre-and-post-processing logic around its next middleware, as described in the section above. Conceptually, as an example, given the middlewares "),t("code",[e._v("A")]),e._v(", "),t("code",[e._v("B")]),e._v(", and "),t("code",[e._v("C")]),e._v(" and the base "),t("code",[e._v("tx.Handler")]),e._v(" "),t("code",[e._v("H")]),e._v(" the stack looks like:")]),e._v(" "),t("p",[t("img",{attrs:{src:"baseapp_transaction-middleware.png",alt:"Composing"}})]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"text",base64:"QS5wcmUKICAgIEIucHJlCiAgICAgICAgQy5wcmUKICAgICAgICAgICAgSGFuZGxlciAjIFRoZSBiYXNlIHR4LmhhbmRsZXIsIGZvciBleGFtcGxlIGBSdW5Nc2dzVHhIYW5kbGVyYAogICAgICAgIEMucG9zdAogICAgQi5wb3N0CkEucG9zdAo="}}),e._v(" "),t("p",[e._v("We define a "),t("code",[e._v("ComposeMiddlewares")]),e._v(' function for composing middlewares. It takes the base handler as first argument, and middlewares in the "outer to inner" order. For the above stack, the final '),t("code",[e._v("tx.Handler")]),e._v(" is:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"dHhIYW5kbGVyIDo9IG1pZGRsZXdhcmUuQ29tcG9zZU1pZGRsZXdhcmVzKEgsIEEsIEIsIEMpCg=="}}),e._v(" "),t("p",[e._v("The middleware is set in BaseApp via its "),t("code",[e._v("SetTxHandler")]),e._v(" setter:")]),e._v(" "),t("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gc2ltYXBwL2FwcC5nbwoKdHhIYW5kbGVyIDo9IG1pZGRsZXdhcmUuQ29tcG9zZU1pZGRsZXdhcmVzKC4uLikKYXBwLlNldFR4SGFuZGxlcih0eEhhbmRsZXIpCg=="}}),e._v(" "),t("p",[e._v("The app developer can define their own middlewares, or use the Cosmos SDK's pre-defined middlewares from "),t("code",[e._v("middleware.NewDefaultTxHandler()")]),e._v(".")]),e._v(" "),t("h3",{attrs:{id:"middlewares-maintained-by-the-cosmos-sdk"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#middlewares-maintained-by-the-cosmos-sdk"}},[e._v("#")]),e._v(" Middlewares Maintained by the Cosmos SDK")]),e._v(" "),t("p",[e._v("While the app developer can define and compose the middlewares of their choice, the Cosmos SDK provides a set of middlewares that caters to the ecosystem's most common use cases. These middlewares are:")]),e._v(" "),t("table",[t("thead",[t("tr",[t("th",[e._v("Middleware")]),e._v(" "),t("th",[e._v("Description")])])]),e._v(" "),t("tbody",[t("tr",[t("td",[e._v("RunMsgsTxHandler")]),e._v(" "),t("td",[e._v("This is the base "),t("code",[e._v("tx.Handler")]),e._v(". It replaces the old baseapp's "),t("code",[e._v("runMsgs")]),e._v(", and executes a transaction's "),t("code",[e._v("Msg")]),e._v("s.")])]),e._v(" "),t("tr",[t("td",[e._v("TxDecoderMiddleware")]),e._v(" "),t("td",[e._v("This middleware takes in transaction raw bytes, and decodes them into a "),t("code",[e._v("sdk.Tx")]),e._v(". It replaces the "),t("code",[e._v("baseapp.txDecoder")]),e._v(" field, so that BaseApp stays as thin as possible. Since most middlewares read the contents of the "),t("code",[e._v("sdk.Tx")]),e._v(", the TxDecoderMiddleware should be run first in the middelware stack.")])]),e._v(" "),t("tr",[t("td"),e._v(" "),t("td",[e._v("Each antehandler is converted to its own middleware. These middlewares perform signature verification, fee deductions and other validations on the incoming transaction.")])]),e._v(" "),t("tr",[t("td",[e._v("IndexEventsTxMiddleware")]),e._v(" "),t("td",[e._v("This is a simple middleware that chooses which events to index in Tendermint. Replaces "),t("code",[e._v("baseapp.indexEvents")]),e._v(" (which unfortunately still exists in baseapp too, because it's used to index Begin/EndBlock events)")])]),e._v(" "),t("tr",[t("td",[e._v("RecoveryTxMiddleware")]),e._v(" "),t("td",[e._v("This index recovers from panics. It replaces baseapp.runTx's panic recovery described in "),t("RouterLink",{attrs:{to:"/core/adr-022-custom-panic-handling.html"}},[e._v("ADR-022")]),e._v(".")],1)]),e._v(" "),t("tr",[t("td",[e._v("GasTxMiddleware")]),e._v(" "),t("td",[e._v("This replaces the "),t("a",{attrs:{href:"https://github.com/cosmos/cosmos-sdk/blob/v0.43.0/x/auth/ante/setup.go",target:"_blank",rel:"noopener noreferrer"}},[t("code",[e._v("Setup")]),t("OutboundLink")],1),e._v(" Antehandler. It sets a GasMeter on sdk.Context. Note that before, GasMeter was set on sdk.Context inside the antehandlers, and there was some mess around the fact that antehandlers had their own panic recovery system so that the GasMeter could be read by baseapp's recovery system. Now, this mess is all removed: one middleware sets GasMeter, another one handles recovery.")])]),e._v(" "),t("tr",[t("td",[e._v("TipMiddleware")]),e._v(" "),t("td",[e._v("This pays for transaction fees using another denom than the native fee denom of the chain. "),t("RouterLink",{attrs:{to:"/core/tips.html"}},[t("code",[e._v("docs")])])],1)]),e._v(" "),t("tr",[t("td",[e._v("SigGasConsumeMiddleware")]),e._v(" "),t("td",[e._v("SigGasConsumeMiddleware consumes parameter-defined amount of gas for each signature.")])]),e._v(" "),t("tr",[t("td",[e._v("SigVerificationMiddleware")]),e._v(" "),t("td",[e._v("verifies all signatures for a tx and return an error if any are invalid")])])])])],1)}),[],!1,null,null,null);a.default=s.exports}}]);